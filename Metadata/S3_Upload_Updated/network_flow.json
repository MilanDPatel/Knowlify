{
    "topic": "The mathematical concept being demonstrated is the process of passing through a series of layers in an artificial neural network",
    "code": [
        "import torch\n",
        "from manim_imports_ext import *\n",
        "from _2024.transformers.helpers import *\n",
        "from _2024.transformers.embedding import *\n",
        "\n",
        "\n",
        "class HighLevelNetworkFlow(InteractiveScene):\n",
        "    # example_text = \"To date, the cleverest thinker of all time was blank\"\n",
        "    use_words = False\n",
        "    # possible_next_tokens = [\n",
        "    #     (\" the\", 0.0882),\n",
        "    #     (\" probably\", 0.0437),\n",
        "    #     (\" John\", 0.0404),\n",
        "    #     (\" Sir\", 0.0366),\n",
        "    #     (\" Albert\", 0.0363),\n",
        "    #     (\" Ber\", 0.0331),\n",
        "    #     (\" a\", 0.029),\n",
        "    #     (\" Isaac\", 0.0201),\n",
        "    #     (\" undoubtedly\", 0.0158),\n",
        "    #     (\" arguably\", 0.0133),\n",
        "    #     (\" Im\", 0.0116),\n",
        "    #     (\" Einstein\", 0.0113),\n",
        "    #     (\" Ludwig\", 0.0104),\n",
        "    # ]\n",
        "    hide_block_labels = False\n",
        "    block_to_title_direction = UP\n",
        "\n",
        "    example_text = \"The Computer History Museum is located in Mountain\"\n",
        "    possible_next_tokens = [\n",
        "        (\"Mountain\", 0.706),\n",
        "        (\"the\", 0.128),\n",
        "        (\"San\", 0.078),\n",
        "        (\"Seattle\", 0.006),\n",
        "        (\"New\", 0.003),\n",
        "        (\"Palo\", 0.002),\n",
        "        (\"Google\", 0.002),\n",
        "        (\"southern\", 0.002),\n",
        "    ]\n",
        "\n",
        "    def setup(self):\n",
        "        super().setup()\n",
        "        self.set_floor_plane(\"xz\")\n",
        "        self.camera.light_source.move_to([-10, 10, 15])\n",
        "        self.camera.light_source.add_updater(lambda m: m.set_z(self.frame.get_z() + 10))\n",
        "        self.layers = VGroup()\n",
        "        self.blocks = Group()\n",
        "        self.mlps = Group()\n",
        "\n",
        "    def construct(self):\n",
        "        frame = self.frame\n",
        "\n",
        "        # Embedding\n",
        "        self.show_initial_text_embedding()\n",
        "\n",
        "        # Passing through some layers\n",
        "        self.progress_through_attention_block(target_frame_x=-2)\n",
        "        self.progress_through_mlp_block(\n",
        "            show_one_by_one=True,\n",
        "            sideview_orientation=(-78, -10, 0),\n",
        "        )\n",
        "\n",
        "        # # Temporary\n",
        "        # block = self.blocks[-1]\n",
        "        # nodes = self.mlps[-1][0]\n",
        "        # lines = self.mlps[-1][1]\n",
        "        # lines.save_state()\n",
        "        # lines.set_stroke(width=0.5, opacity=0.5)\n",
        "        # self.play(\n",
        "        #     FadeOut(self.token_blocks),\n",
        "        #     FadeOut(self.token_arrows),\n",
        "        #     FadeOut(self.final_word_question),\n",
        "        #     FadeOut(self.blocks[0]),\n",
        "        #     FadeOut(self.layers),\n",
        "        #     FadeOut(block[0]),\n",
        "        # )\n",
        "        # self.play(\n",
        "        #     self.frame.animate.reorient(-65, -8, 0, (-0.77, 1.7, 7.26), 12.57),\n",
        "        #     Restore(lines, lag_ratio=0.01),\n",
        "        #     run_time=4\n",
        "        # )\n",
        "        # self.play(self.frame.animate.reorient(-15, -8, 0, (-0.77, 1.7, 7.26), 12.57), run_time=4)\n",
        "\n",
        "        #\n",
        "        orientation = frame.get_euler_angles() / DEGREES\n",
        "        mlp_kw = dict(sideview_orientation=orientation, final_orientation=orientation)\n",
        "        att_kw = dict(target_orientation=orientation)\n",
        "        for x in [-3, -4, -5, -6, -7]:\n",
        "            self.progress_through_attention_block(target_frame_x=x, **att_kw)\n",
        "            self.progress_through_mlp_block(**mlp_kw)\n",
        "\n",
        "        # Show how it ends\n",
        "        self.remove_mlps()\n",
        "        self.mention_repetitions()\n",
        "        self.focus_on_last_layer()\n",
        "        self.show_unembedding()\n",
        "\n",
        "    def get_embedding_array(\n",
        "        self,\n",
        "        shape=(9, 10),\n",
        "        height=4,\n",
        "        dots_index=-4,\n",
        "        buff_ratio=0.4,\n",
        "        bracket_color=GREY_B,\n",
        "        backstroke_width=3,\n",
        "        add_background_rectangle=False,\n",
        "    ):\n",
        "        return EmbeddingArray(\n",
        "            shape=shape,\n",
        "            height=height,\n",
        "            dots_index=dots_index,\n",
        "            buff_ratio=buff_ratio,\n",
        "            bracket_color=bracket_color,\n",
        "            backstroke_width=backstroke_width,\n",
        "            add_background_rectangle=add_background_rectangle,\n",
        "        )\n",
        "\n",
        "    def swap_embedding_for_dots(self, embedding_array, dots_index=-4):\n",
        "        embedding_array.swap_embedding_for_dots(dots_index)\n",
        "\n",
        "    def get_next_layer_array(self, embedding_array, z_buff=3.0):\n",
        "        next_array = embedding_array.copy()\n",
        "        embeddings = [part for part in next_array if isinstance(part, NumericEmbedding)]\n",
        "        for embedding in embeddings:\n",
        "            for entry in embedding.get_entries():\n",
        "                entry.set_value(random.uniform(*embedding.value_range))\n",
        "        next_array.shift(z_buff * OUT)\n",
        "        return next_array\n",
        "\n",
        "    def get_block(\n",
        "        self,\n",
        "        layer,\n",
        "        depth=2.0,\n",
        "        buff=1.0,\n",
        "        size_buff=1.0,\n",
        "        color=GREY_E,\n",
        "        opacity=0.75,\n",
        "        shading=(0.25, 0.1, 0.0),\n",
        "        title=\"Attention\",\n",
        "        title_font_size=96,\n",
        "        title_backstroke_width=3,\n",
        "    ):\n",
        "        # Block\n",
        "        body = Cube(color=color, opacity=opacity)\n",
        "        body.deactivate_depth_test()\n",
        "        width, height = layer.get_shape()[:2]\n",
        "        body.set_shape(width + size_buff, height + size_buff, depth)\n",
        "        body.set_shading(0.5, 0.5, 0.0)\n",
        "        body.next_to(layer, OUT, buff=buff)\n",
        "        body.sort(lambda p: np.dot(p, [-1, 1, 1]))\n",
        "\n",
        "        title = Text(title, font_size=title_font_size)\n",
        "        title.set_backstroke(BLACK, title_backstroke_width)\n",
        "        title.next_to(body, self.block_to_title_direction, buff=0.1)\n",
        "        block = Group(body, title)\n",
        "        block.body = body\n",
        "        block.title = title\n",
        "        if self.hide_block_labels:\n",
        "            title.set_opacity(0)\n",
        "\n",
        "        return block\n",
        "\n",
        "    def show_initial_text_embedding(self, word_scale_factor=0.6, bump_first=False):\n",
        "        # Mention next word prediction task\n",
        "        phrase = Text(self.example_text)\n",
        "        phrase.set_max_width(FRAME_WIDTH - 1)\n",
        "        if self.use_words:\n",
        "            words = break_into_words(phrase)\n",
        "            rects = get_piece_rectangles(words)\n",
        "        else:\n",
        "            words = break_into_tokens(phrase)\n",
        "            rects = get_piece_rectangles(\n",
        "                words, leading_spaces=True, h_buff=0\n",
        "            )\n",
        "\n",
        "        words.remove(words[-1])\n",
        "        q_marks = Text(\"???\")\n",
        "        rects[-1].set_color(YELLOW)\n",
        "        q_marks.next_to(rects[-1], DOWN)\n",
        "\n",
        "        big_rect = Rectangle()\n",
        "        big_rect.replace(rects[:-1], stretch=True)\n",
        "        big_rect.set_stroke(GREY_B, 2)\n",
        "        arrow = Arrow(big_rect.get_top(), rects[-1].get_top(), path_arc=-120 * DEGREES)\n",
        "        arrow.scale(0.5, about_edge=DR)\n",
        "\n",
        "        self.play(ShowIncreasingSubsets(words, run_time=1))\n",
        "        self.add(rects[-1])\n",
        "        self.play(LaggedStart(\n",
        "            FadeIn(big_rect),\n",
        "            ShowCreation(arrow),\n",
        "            Write(q_marks),\n",
        "            lag_ratio=0.3,\n",
        "        ))\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            FadeOut(big_rect),\n",
        "            LaggedStart(*(\n",
        "                DrawBorderThenFill(rect)\n",
        "                for rect in rects[:-1]\n",
        "            ), lag_ratio=0.02),\n",
        "            LaggedStart(*(\n",
        "                token.animate.match_color(rect)\n",
        "                for token, rect in zip(words, rects)\n",
        "            )),\n",
        "            FadeOut(arrow)\n",
        "        )\n",
        "        self.wait()\n",
        "\n",
        "        # Label the tokens\n",
        "        token_label = Text(\"Tokens\", font_size=72)\n",
        "        token_label.to_edge(UP)\n",
        "        arrows = VGroup(\n",
        "            Arrow(token_label.get_bottom(), rect.get_top()).match_color(rect)\n",
        "            for rect in rects[:-1]\n",
        "        )\n",
        "\n",
        "        self.play(FadeIn(token_label, UP))\n",
        "        self.play(LaggedStartMap(VFadeInThenOut, arrows, lag_ratio=0.25, run_time=4))\n",
        "        self.play(FadeOut(token_label, DOWN))\n",
        "\n",
        "        # Show words into vectors\n",
        "        layer = self.get_embedding_array(\n",
        "            shape=(10, len(words)),\n",
        "            dots_index=None,\n",
        "        )\n",
        "        vectors = layer.embeddings\n",
        "\n",
        "        blocks = VGroup(*(VGroup(rect, token) for rect, token in zip(rects, words)))\n",
        "        q_group = VGroup(rects[-1], q_marks)\n",
        "        blocks.target = blocks.generate_target()\n",
        "        for block, vector in zip(blocks.target, vectors):\n",
        "            block.scale(word_scale_factor)\n",
        "            block.next_to(layer, UP, buff=1.5)\n",
        "            block.match_x(vector)\n",
        "\n",
        "        arrows = VGroup(*(\n",
        "            Arrow(block, vect, stroke_width=3)\n",
        "            for block, vect in zip(blocks.target, vectors)\n",
        "        ))\n",
        "        word_to_index = dict(zip(self.example_text.split(\" \"), it.count()))\n",
        "        # self.swap_embedding_for_dots(layer, word_to_index.get(\"...\", -4))\n",
        "\n",
        "        if bump_first:\n",
        "            blocks.target[0].next_to(blocks.target[1], LEFT, buff=0.1)\n",
        "\n",
        "        self.play(\n",
        "            self.frame.animate.move_to(1.0 * UP),\n",
        "            MoveToTarget(blocks),\n",
        "            q_group.animate.scale(word_scale_factor).next_to(blocks.target, RIGHT, aligned_edge=UP),\n",
        "            LaggedStartMap(FadeIn, vectors, shift=0.5 * DOWN),\n",
        "            LaggedStartMap(GrowFromCenter, arrows),\n",
        "            Write(layer.dots)\n",
        "        )\n",
        "        # self.play(Write(layer.brackets))\n",
        "        self.wait()\n",
        "\n",
        "        self.token_blocks = blocks\n",
        "        self.token_arrows = arrows\n",
        "        self.final_word_question = VGroup(rects[-1], q_marks)\n",
        "\n",
        "        self.layers.add(layer)\n",
        "\n",
        "    def progress_through_attention_block(\n",
        "        self,\n",
        "        depth=2.0,\n",
        "        target_orientation=(-40, -15, 0),\n",
        "        target_frame_height=14,\n",
        "        target_frame_x=-2,\n",
        "        target_frame_y=0,\n",
        "        attention_anim_run_time=5,\n",
        "        label_text=\"Attention\"\n",
        "    ):\n",
        "        # self.embed()\n",
        "        # # Test\n",
        "        # self.frame.clear_updaters()\n",
        "        # attention_anim_run_time = 16\n",
        "        # target_orientation = (-53, -16, 0, (-1.08, -0.57, 1.12), 11.27)\n",
        "        # self.camera.light_source.set_z(10)\n",
        "\n",
        "        layer = self.layers[-1]\n",
        "        layer.brackets.set_fill(opacity=1)\n",
        "        layer.save_state()\n",
        "        block = self.get_block(layer, title=label_text, depth=depth)\n",
        "        z_diff = block.get_z() - layer.get_z()\n",
        "        block_opacity = block.body[0].get_opacity()\n",
        "        block.body[0].set_opacity(0)\n",
        "        block.title.set_backstroke(BLACK, 5)\n",
        "        new_layer = layer.copy()\n",
        "        new_layer.match_z(block)\n",
        "        new_layer.set_backstroke(BLACK, 1)\n",
        "\n",
        "        self.frame.target = self.frame.generate_target()\n",
        "        self.frame.target.reorient(*target_orientation)\n",
        "        self.frame.target.set_height(target_frame_height)\n",
        "        self.frame.target.set_x(target_frame_x)\n",
        "        self.frame.target.set_y(target_frame_y)\n",
        "\n",
        "        self.play(\n",
        "            MoveToTarget(self.frame),\n",
        "            LaggedStart(\n",
        "                layer.animate.set_opacity(0.25),\n",
        "                FadeIn(block),\n",
        "                TransformFromCopy(layer, new_layer),\n",
        "                (self.blocks[-1].title if len(self.blocks) > 0 else VGroup()).animate.set_opacity(0.25),\n",
        "                lag_ratio=0.3\n",
        "            ),\n",
        "            self.token_arrows.animate.set_opacity(0.1),\n",
        "            run_time=2\n",
        "        )\n",
        "        self.play_simple_attention_animation(\n",
        "            new_layer,\n",
        "            run_time=attention_anim_run_time,\n",
        "            added_anims=[self.frame.animate.reorient(0, -15, 0, (-0.07, 0.45, 2.03), 9.25)]\n",
        "        )\n",
        "\n",
        "        # Take new layer out of block\n",
        "        self.add(*block.body, block.title, new_layer)\n",
        "        new_z = block.get_z() + z_diff\n",
        "        self.play(\n",
        "            block.body[0].animate.set_opacity(block_opacity),\n",
        "            new_layer.animate.set_z(new_z),\n",
        "            self.frame.animate.set_z(new_z),\n",
        "            Restore(layer),\n",
        "        )\n",
        "        self.add(block, new_layer)\n",
        "\n",
        "        if False:\n",
        "            # Highlight example\n",
        "            index = 4\n",
        "            highlight = new_layer[0][index].copy()\n",
        "            highlight.set_backstroke(BLACK, 3)\n",
        "            highlight.set_fill(border_width=1)\n",
        "            rect = SurroundingRectangle(highlight)\n",
        "            rect.set_stroke(TEAL, 3)\n",
        "            new_arrow = Arrow(self.token_blocks[index].get_bottom(), rect.get_top(), tip_angle=45 * DEGREES)\n",
        "            new_arrow.set_fill(GREY_A, border_width=4)\n",
        "\n",
        "            self.add(block.body, new_layer, block.title),\n",
        "            self.play(LaggedStart(\n",
        "                self.frame.animate.reorient(0, -14, 0, (-0.18, 0.73, 3.26), 8.31),\n",
        "                block.body.animate.set_color(BLACK).set_shading(0.1, 0.1, 0.5),\n",
        "                block.title.animate.set_opacity(0.1),\n",
        "                new_layer.animate.fade(0.75).set_stroke(width=0),\n",
        "                self.token_blocks[index].animate.scale(2, about_edge=DOWN),\n",
        "                self.token_blocks[:index].animate.shift(0.35 * LEFT),\n",
        "                FadeIn(highlight),\n",
        "                ShowCreation(rect),\n",
        "                FadeIn(new_arrow, scale=4),\n",
        "                run_time=3\n",
        "            ))\n",
        "            self.wait()\n",
        "\n",
        "        self.blocks.add(block)\n",
        "        self.layers.add(new_layer)\n",
        "\n",
        "    def play_simple_attention_animation(self, layer, run_time=5, added_anims=[]):\n",
        "        arc_groups = VGroup()\n",
        "        for _ in range(3):\n",
        "            for n, e1 in enumerate(layer.embeddings):\n",
        "                arc_group = VGroup()\n",
        "                for e2 in layer.embeddings[n + 1:]:\n",
        "                    sign = (-1)**int(e2.get_x() > e1.get_x())\n",
        "                    arc_group.add(Line(\n",
        "                        e1.get_top(), e2.get_top(),\n",
        "                        path_arc=sign * PI / 3,\n",
        "                        stroke_color=random_bright_color(hue_range=(0.1, 0.3)),\n",
        "                        stroke_width=5 * random.random()**5,\n",
        "                    ))\n",
        "                arc_group.shuffle()\n",
        "                if len(arc_group) > 0:\n",
        "                    arc_groups.add(arc_group)\n",
        "\n",
        "        self.play(\n",
        "            LaggedStart(*(\n",
        "                AnimationGroup(\n",
        "                    LaggedStartMap(VShowPassingFlash, arc_group.copy(), time_width=2, lag_ratio=0.15),\n",
        "                    LaggedStartMap(ShowCreationThenFadeOut, arc_group, lag_ratio=0.15),\n",
        "                )\n",
        "                for arc_group in arc_groups\n",
        "            ), lag_ratio=0.0),\n",
        "            LaggedStartMap(RandomizeMatrixEntries, layer.embeddings, lag_ratio=0.0),\n",
        "            *added_anims,\n",
        "            run_time=run_time\n",
        "        )\n",
        "        self.add(layer)\n",
        "\n",
        "    def progress_through_mlp_block(\n",
        "        self,\n",
        "        n_neurons=20,\n",
        "        # depth=3.0,\n",
        "        depth=4.0,\n",
        "        buff=1.0,\n",
        "        dot_buff_ratio=0.2,\n",
        "        neuron_color=GREY_C,\n",
        "        neuron_shading=(0.25, 0.75, 0.2),\n",
        "        sideview_orientation=(-60, -5, 0),\n",
        "        final_orientation=(-51, -18, 0),\n",
        "        show_one_by_one=False,\n",
        "        # label_text=\"Multilayer\\nPerceptron\",\n",
        "        # title_font_size=72,\n",
        "        label_text=\"Feedforward\",\n",
        "        title_font_size=90,\n",
        "    ):\n",
        "        # MLP Test\n",
        "        layer = self.layers[-1]\n",
        "        block = self.get_block(\n",
        "            layer,\n",
        "            depth=depth,\n",
        "            buff=buff,\n",
        "            size_buff=1.0,\n",
        "            title=label_text,\n",
        "            title_font_size=title_font_size,\n",
        "        )\n",
        "\n",
        "        # New layer\n",
        "        new_layer = self.get_next_layer_array(layer)\n",
        "        new_layer.next_to(block.body, OUT, buff)\n",
        "\n",
        "        # Neurons\n",
        "        def get_neurons(points):\n",
        "            neurons = DotCloud(points, radius=0.1)\n",
        "            neurons.make_3d()\n",
        "            neurons.set_glow_factor(0)\n",
        "            neurons.set_shading(*neuron_shading)\n",
        "            neurons.set_color(neuron_color)\n",
        "            neurons.set_opacity(np.random.uniform(0.5, 1, len(points)))\n",
        "            return neurons\n",
        "\n",
        "        all_neuron_points = np.zeros((0, 3))\n",
        "        neuron_clusters = Group()\n",
        "        connections = VGroup()\n",
        "        y_min = block.body.get_y(DOWN) + SMALL_BUFF\n",
        "        y_max = block.body.get_y(UP) - SMALL_BUFF\n",
        "        block_z = block.body.get_z()\n",
        "        for embedding in layer.embeddings:\n",
        "            l1_points = np.array([e.get_center() for e in embedding.get_columns()[0]])\n",
        "            l3_points = l1_points.copy()\n",
        "            l1_points[:, 2] = block_z - 0.4 * depth\n",
        "            l3_points[:, 2] = block_z + 0.4 * depth\n",
        "            x0, y0, z0 = embedding.get_center()\n",
        "            l2_points = np.array([\n",
        "                [x0, y, block_z]\n",
        "                for y in np.linspace(y_min, y_max, n_neurons)\n",
        "            ])\n",
        "            new_points = np.vstack([l1_points, l2_points, l3_points])\n",
        "            all_neuron_points = np.vstack([all_neuron_points, new_points])\n",
        "            neuron_clusters.add(get_neurons(new_points))\n",
        "            # Lines\n",
        "            weights = VGroup(*(\n",
        "                Line(\n",
        "                    p1, p2,\n",
        "                    buff=0.1,\n",
        "                    stroke_width=3,\n",
        "                    stroke_opacity=random.random(),\n",
        "                    stroke_color=value_to_color(random.uniform(-10, 10))\n",
        "                )\n",
        "                for points1, points2 in [\n",
        "                    [l1_points, l2_points],\n",
        "                    [l2_points, l3_points],\n",
        "                ]\n",
        "                for p1, p2 in it.product(points1, points2)\n",
        "                if random.random() < 0.2\n",
        "            ))\n",
        "            connections.add(weights)\n",
        "        neurons = get_neurons(all_neuron_points)\n",
        "        connections.apply_depth_test()\n",
        "        connections.set_flat_stroke(False)\n",
        "\n",
        "        # Flow through layer\n",
        "        if show_one_by_one:\n",
        "            networks = Group(*(Group(cluster, lines.copy()) for cluster, lines in zip(neuron_clusters, connections)))\n",
        "            last_network = VectorizedPoint()\n",
        "            emb_pairs = list(zip(layer.embeddings, new_layer.embeddings))\n",
        "            index = 4\n",
        "            block.title.rotate(PI / 2, DOWN)\n",
        "            self.play(\n",
        "                self.blocks[-1].title.animate.set_opacity(0.25),\n",
        "                FadeIn(block.title, time_span=(0, 1)),\n",
        "                self.frame.animate.reorient(*sideview_orientation),\n",
        "                Write(networks[index][1]),\n",
        "                FadeIn(networks[index][0]),\n",
        "                FadeTransform(emb_pairs[index][0].copy(), emb_pairs[index][1]),\n",
        "                run_time=3\n",
        "            )\n",
        "            lag_kw = dict(lag_ratio=0.5, run_time=9)\n",
        "            self.remove(block.title)\n",
        "            self.play(\n",
        "                LaggedStart(*(\n",
        "                    FadeTransform(e1.copy(), e2)\n",
        "                    for e1, e2 in [*emb_pairs[:index], *emb_pairs[index + 1:]]\n",
        "                ), **lag_kw),\n",
        "                LaggedStart(*(\n",
        "                    Write(network[1])\n",
        "                    for network in [*networks[:index], *networks[index + 1:]]\n",
        "                ), **lag_kw),\n",
        "                LaggedStart(*(\n",
        "                    FadeIn(network[0])\n",
        "                    for network in [*networks[:index], *networks[index + 1:]]\n",
        "                ), **lag_kw),\n",
        "                self.frame.animate.reorient(0, -37, 0, (-1.08, 2.29, 7.99), 12.27),\n",
        "                block.title.animate.rotate(PI / 2, UP),\n",
        "                run_time=15,\n",
        "            )\n",
        "            self.remove(networks)\n",
        "            self.add(neurons, connections, block.body, block.title, new_layer)\n",
        "            self.play(\n",
        "                FadeIn(block.body),\n",
        "                FadeIn(new_layer),\n",
        "                FadeOut(new_layer.embeddings.copy()),\n",
        "                # self.frame.animate.reorient(*final_orientation).match_z(new_layer),\n",
        "                self.frame.animate.reorient(-48, -12, 0).match_z(new_layer),\n",
        "                run_time=2\n",
        "            )\n",
        "        else:\n",
        "            self.play(\n",
        "                FadeIn(block.title, time_span=(0, 1)),\n",
        "                self.blocks[-1].title.animate.set_opacity(0.25),\n",
        "                self.frame.animate.reorient(*sideview_orientation),\n",
        "                FadeIn(neurons, time_span=(0, 1)),\n",
        "                Write(connections, stroke_width=3),\n",
        "                TransformFromCopy(layer, new_layer),\n",
        "                run_time=3\n",
        "            )\n",
        "            self.add(block.body, block.title, new_layer)\n",
        "            self.play(\n",
        "                self.frame.animate.reorient(*final_orientation).match_z(new_layer),\n",
        "                FadeIn(block.body),\n",
        "                run_time=2,\n",
        "            )\n",
        "\n",
        "        # Aggregate\n",
        "        self.mlps.add(Group(neurons, connections))\n",
        "        self.blocks.add(block)\n",
        "        self.layers.add(new_layer)\n",
        "\n",
        "    def remove_mlps(self):\n",
        "        self.remove(self.mlps)\n",
        "\n",
        "    def mention_repetitions(self, depth=8):\n",
        "        # Mention repetition\n",
        "        frame = self.frame\n",
        "        layer = self.layers[-1]\n",
        "        block = self.blocks[-1].body\n",
        "\n",
        "        thin_blocks = block.replicate(2)\n",
        "        thin_blocks.set_depth(1.0, stretch=True)\n",
        "\n",
        "        dots = Tex(\".....\", font_size=250)\n",
        "        brace = Brace(dots, UP)\n",
        "        brace_text = brace.get_text(\"Many\\nrepetitions\")\n",
        "        rep_label = Group(dots, brace, brace_text)\n",
        "        rep_label.set_width(depth)\n",
        "        rep_label.rotate(PI / 2, DOWN)\n",
        "        rep_label.next_to(layer, OUT, buff=3.0)\n",
        "        rep_label.align_to(ORIGIN, DOWN)\n",
        "\n",
        "        thin_blocks[0].align_to(brace, IN)\n",
        "        thin_blocks[1].align_to(brace, OUT)\n",
        "        dots.scale(0.5)\n",
        "        VGroup(brace, brace_text).next_to(thin_blocks, UP)\n",
        "\n",
        "        final_layer = self.get_next_layer_array(layer)\n",
        "        final_layer.set_z(rep_label.get_z(OUT) + 1)\n",
        "        final_layer.save_state()\n",
        "        final_layer.become(layer)\n",
        "        final_layer.set_opacity(0)\n",
        "\n",
        "        self.play(\n",
        "            frame.animate.reorient(-57, -8, 0, (-6.59, 1.2, 57.84), 30),\n",
        "            FadeIn(thin_blocks, lag_ratio=0.1),\n",
        "            GrowFromCenter(brace),\n",
        "            Write(brace_text, time_span=(1, 2)),\n",
        "            Write(dots),\n",
        "            run_time=3\n",
        "        )\n",
        "        self.play(\n",
        "            Restore(final_layer, run_time=2)\n",
        "        )\n",
        "        self.wait()\n",
        "\n",
        "        self.rep_label = rep_label\n",
        "        self.blocks.add(*thin_blocks)\n",
        "        self.layers.add(final_layer)\n",
        "\n",
        "    def focus_on_last_layer(self):\n",
        "        # Last Layer\n",
        "        layer = self.layers[-1]\n",
        "        rect = BackgroundRectangle(layer)\n",
        "        rect.set_fill(BLACK, 0.5)\n",
        "        rect.scale(3)\n",
        "\n",
        "        self.rep_label.target = self.rep_label.generate_target()\n",
        "        self.rep_label.target[1:].set_opacity(0)\n",
        "        self.rep_label.target[0].set_opacity(0.5)\n",
        "\n",
        "        target_frame_center = layer.get_center() + 4 * RIGHT + UP\n",
        "\n",
        "        self.add(self.rep_label, rect, layer)\n",
        "        self.play(\n",
        "            FadeIn(rect),\n",
        "            MoveToTarget(self.rep_label),\n",
        "            *map(FadeOut, [block.title for block in self.blocks if hasattr(block, \"title\")]),\n",
        "            self.frame.animate.reorient(-3, -12, 0, target_frame_center, 12.00),\n",
        "            run_time=3,\n",
        "        )\n",
        "\n",
        "    def show_unembedding(self):\n",
        "        # Unembedding\n",
        "        label_font_size = 30\n",
        "        layer = self.layers[-1]\n",
        "        last_embedding = layer.embeddings[-1]\n",
        "        rect = SurroundingRectangle(last_embedding)\n",
        "        rect.set_stroke(YELLOW, 3)\n",
        "\n",
        "        words, dist = zip(*self.possible_next_tokens)\n",
        "        bars = BarChart(dist).bars\n",
        "        bars.rotate(-90 * DEGREES)\n",
        "        bars.set_width(2.5, stretch=True)\n",
        "        bars.next_to(layer, RIGHT, buff=4.0)\n",
        "        bars.set_y(2)\n",
        "        for bar, word, value in zip(bars, words, dist):\n",
        "            percentage = DecimalNumber(\n",
        "                100 * value,\n",
        "                num_decimal_places=2,\n",
        "                unit=\"%\",\n",
        "                font_size=label_font_size,\n",
        "            )\n",
        "            percentage.next_to(bar, RIGHT)\n",
        "            text = Text(word, font_size=label_font_size)\n",
        "            text.next_to(bar, LEFT)\n",
        "            bar.push_self_into_submobjects()\n",
        "            bar.add(text, percentage)\n",
        "\n",
        "        dots = Tex(R\"\\vdots\")\n",
        "        dots.next_to(bars[-1][1], DOWN)\n",
        "        bars.add(dots)\n",
        "        brace = Brace(bars, LEFT)\n",
        "\n",
        "        arrow = Line()\n",
        "        arrow.clear_points()\n",
        "        arrow.start_new_path(rect.get_top())\n",
        "        arrow.add_cubic_bezier_curve_to(\n",
        "            rect.get_top() + UP,\n",
        "            rect.get_top() + UR,\n",
        "            rect.get_top() + 2 * RIGHT,\n",
        "        )\n",
        "        arrow.add_line_to(\n",
        "            brace.get_left() + 0.1 * LEFT,\n",
        "        )\n",
        "        arrow.make_smooth(approx=False)\n",
        "        arrow.add_tip()\n",
        "        arrow.set_color(YELLOW)\n",
        "\n",
        "        self.play(ShowCreation(rect))\n",
        "        self.play(\n",
        "            ShowCreation(arrow),\n",
        "            GrowFromCenter(brace),\n",
        "            LaggedStartMap(FadeIn, bars, shift=DOWN)\n",
        "        )\n",
        "        self.wait()\n",
        "        # Test\n",
        "        self.play(\n",
        "            self.frame.animate.reorient(-5, -8, 0, (2.99, 2.67, 71.6), 13.60),\n",
        "            run_time=8\n",
        "        )\n",
        "\n",
        "\n",
        "class SimplifiedFlow(HighLevelNetworkFlow):\n",
        "    example_text = \"Word vectors will be updated to encode more than mere words\"\n",
        "    attention_anim_run_time = 1.0\n",
        "    orientation = (-55, -19, 0)\n",
        "    target_frame_x = -2\n",
        "    x_range = np.linspace(-2, -8, 5)\n",
        "    frame_height_growth_rate = 0.15\n",
        "\n",
        "    def construct(self):\n",
        "        # Test\n",
        "        self.camera.light_source.set_z(60)\n",
        "        self.show_initial_text_embedding(word_scale_factor=0.6)\n",
        "        self.show_simple_flow(self.x_range)\n",
        "\n",
        "    def show_simple_flow(self, x_range, orientation=None):\n",
        "        if orientation is None:\n",
        "            orientation = self.orientation\n",
        "        curr_time = float(self.time)\n",
        "        curr_height = self.frame.get_height()\n",
        "        self.frame.add_updater(lambda f: f.set_height(curr_height + self.frame_height_growth_rate * (self.time - curr_time)))\n",
        "        for x in x_range:\n",
        "            self.progress_through_attention_block(\n",
        "                target_orientation=orientation,\n",
        "                target_frame_x=self.target_frame_x,\n",
        "                attention_anim_run_time=self.attention_anim_run_time,\n",
        "            )\n",
        "            self.progress_through_mlp_block(\n",
        "                sideview_orientation=orientation,\n",
        "                final_orientation=orientation,\n",
        "            )\n",
        "\n",
        "\n",
        "class AltIntro(HighLevelNetworkFlow):\n",
        "    example_text = \"Four score and seven years ago our fathers\"\n",
        "\n",
        "    def construct(self):\n",
        "        self.show_initial_text_embedding(word_scale_factor=0.6)\n",
        "\n",
        "\n",
        "class SimplifiedFlowAlternateAngle(SimplifiedFlow):\n",
        "    example_text = \"The goal of the network is to predict the next token\"\n",
        "    attention_anim_run_time = 1.0\n",
        "    orientation = (-10, -20, 0)\n",
        "    target_frame_x = 0\n",
        "    hide_block_labels = True\n",
        "\n",
        "\n",
        "class LongerFlowLongerAttention(SimplifiedFlow):\n",
        "    example_text = \"The goal of the network is to predict the next token\"\n",
        "    attention_anim_run_time = 3.0\n",
        "    target_frame_x = 0\n",
        "    hide_block_labels = True\n",
        "    x_range = np.linspace(-2, -12, 7)\n",
        "\n",
        "\n",
        "class MentionContextSizeAndUnembedding(SimplifiedFlow):\n",
        "    example_text = \"Harry Potter was a highly unusual boy ... least favourite teacher, Professor Snape\"\n",
        "    attention_anim_run_time = 5.0\n",
        "    use_words = True\n",
        "\n",
        "    def construct(self):\n",
        "        # Initial flow\n",
        "        self.show_initial_text_embedding(word_scale_factor=0.5)\n",
        "        self.cycle_through_embeddings()\n",
        "        self.show_simple_flow(\n",
        "            np.linspace(-2, -5, 2),\n",
        "            orientation=(-50, -19, 0)\n",
        "        )\n",
        "        self.show_context_size()\n",
        "\n",
        "        # Skip to the end\n",
        "        self.remove_mlps()\n",
        "        self.mention_repetitions()\n",
        "        self.focus_on_last_layer()\n",
        "        self.remove(*self.layers[:-1])\n",
        "\n",
        "        # Discuss unembedding\n",
        "        self.show_desired_output()\n",
        "        self.show_unembedding_matrix()\n",
        "\n",
        "    def cycle_through_embeddings(self):\n",
        "        layer = self.layers[0]\n",
        "        blocks = self.token_blocks\n",
        "        arrows = self.token_arrows\n",
        "        embeddings = VGroup(*layer.embeddings, *layer.dots)\n",
        "        embeddings.sort(lambda p: p[0])\n",
        "        rect_groups = VGroup(*(\n",
        "            VGroup(*(\n",
        "                BackgroundRectangle(mob, buff=0.2 if mob in arrows else 0.1)\n",
        "                for mob in tup\n",
        "            ))\n",
        "            for tup in zip(blocks, arrows, embeddings)\n",
        "        ))\n",
        "        rect_groups.set_opacity(0)\n",
        "        self.add(rect_groups)\n",
        "\n",
        "        for index in range(len(rect_groups)):\n",
        "            rect_groups.generate_target()\n",
        "            rect_groups.target.set_opacity(0.75)\n",
        "            rect_groups.target[index].set_opacity(0)\n",
        "            self.play(MoveToTarget(rect_groups))\n",
        "        self.play(FadeOut(rect_groups))\n",
        "\n",
        "    def show_context_size(self):\n",
        "        # Zoom in\n",
        "        frame = self.frame\n",
        "        frame.save_state()\n",
        "        block_titles = VGroup(*(block.title for block in self.blocks))\n",
        "        layer = self.layers[-1]\n",
        "\n",
        "        self.play(\n",
        "            frame.animate.reorient(-27, -18, 0, (-0.84, -0.36, 18.15), 9.00),\n",
        "            FadeOut(block_titles, lag_ratio=0.01),\n",
        "            run_time=2,\n",
        "        )\n",
        "\n",
        "        # Show size\n",
        "        font_size = 72\n",
        "        brace = Brace(layer.embeddings, DOWN)\n",
        "        label = brace.get_text(\"Context size\", font_size=font_size)\n",
        "        label.generate_target()\n",
        "        rhs = Tex(\"= 2{,}048\", font_size=font_size)\n",
        "        full_label = VGroup(label.target, rhs)\n",
        "        full_label.arrange(RIGHT, aligned_edge=UP)\n",
        "        full_label.next_to(brace, DOWN)\n",
        "\n",
        "        dim_brace = Brace(layer.embeddings, RIGHT)\n",
        "        dim_label = dim_brace.get_text(\"12,288\", font_size=font_size)\n",
        "\n",
        "        self.play(\n",
        "            GrowFromCenter(brace),\n",
        "            FadeIn(label, 0.5 * DOWN),\n",
        "        )\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            MoveToTarget(label),\n",
        "            Write(rhs)\n",
        "        )\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            FadeOut(layer.brackets),\n",
        "            GrowFromCenter(dim_brace),\n",
        "            FadeIn(dim_label, 0.5 * LEFT),\n",
        "        )\n",
        "        self.wait(3)\n",
        "\n",
        "        # Return\n",
        "        self.play(\n",
        "            Restore(frame, run_time=3),\n",
        "            FadeIn(block_titles, time_span=(2, 3), lag_ratio=0.01),\n",
        "            FadeIn(layer.brackets),\n",
        "            LaggedStartMap(FadeOut, VGroup(\n",
        "                brace, label, rhs, dim_brace, dim_label\n",
        "            ), shift=DOWN)\n",
        "        )\n",
        "        for layer, block in zip(self.layers, self.blocks):\n",
        "            self.add(layer, block)\n",
        "        self.add(self.layers[-1])\n",
        "\n",
        "    def show_desired_output(self):\n",
        "        # Show phrase\n",
        "        frame = self.frame\n",
        "        phrase = Text(self.example_text)\n",
        "        phrase.set_max_width(FRAME_WIDTH - 1)\n",
        "        phrase.to_corner(UL)\n",
        "        phrase.fix_in_frame()\n",
        "        last_word = phrase[self.example_text.split(\" \")[-1]][0]\n",
        "        last_word.set_opacity(0)\n",
        "        rect = SurroundingRectangle(last_word, buff=0.1)\n",
        "        rect.set_stroke(YELLOW, 2)\n",
        "        rect.set_fill(YELLOW, 0.5)\n",
        "        rect.align_to(last_word, LEFT)\n",
        "        q_marks = Text(\"???\")\n",
        "        q_marks.next_to(rect, DOWN)\n",
        "        q_group = VGroup(rect, q_marks)\n",
        "        q_group.fix_in_frame()\n",
        "\n",
        "        self.play(FadeIn(phrase, lag_ratio=0.1, run_time=2))\n",
        "        self.play(FadeIn(q_group, 0.2 * RIGHT))\n",
        "        self.wait()\n",
        "\n",
        "        # Get all possible next words\n",
        "        layer = self.layers[-1]\n",
        "        word_strs = [\n",
        "            \"...\",\n",
        "            \"Snake\",\n",
        "            \"Snape\",\n",
        "            \"Snare\",\n",
        "            \"...\",\n",
        "            \"Treks\",\n",
        "            \"Trelawney\",\n",
        "            \"Trellis\",\n",
        "            \"...\",\n",
        "            \"Quirky\",\n",
        "            \"Quirrell\",\n",
        "            \"Quirt\",\n",
        "            \"...\"\n",
        "        ]\n",
        "        words = VGroup()\n",
        "        dots = VGroup()\n",
        "        for word_str in word_strs:\n",
        "            word = Text(word_str)\n",
        "            words.add(word)\n",
        "            if word_str == \"...\":\n",
        "                dots.add(word)\n",
        "                word.rotate(PI / 2)\n",
        "        words.arrange(DOWN, aligned_edge=LEFT)\n",
        "        dots.shift(0.25 * RIGHT)\n",
        "        words.set_max_height(5.0)\n",
        "        words.to_edge(DOWN, buff=1.0)\n",
        "        words.to_edge(RIGHT, buff=0.1)\n",
        "        words.fix_in_frame()\n",
        "\n",
        "        # Add probability bars\n",
        "        values = [0, 0.78, 0, 0, 0.16, 0, 0, 0.06, 0]\n",
        "        bars = VGroup()\n",
        "        probs = VGroup()\n",
        "        value_iter = iter(values)\n",
        "        bar_height = 0.8 * words[1].get_height()\n",
        "        for word in words:\n",
        "            if word in dots:\n",
        "                continue\n",
        "            value = next(value_iter)\n",
        "            prob = DecimalNumber(value, font_size=24)\n",
        "            bar = Rectangle(10 * value * bar_height, bar_height)\n",
        "            bar.next_to(word, LEFT)\n",
        "            hsl = list(Color(BLUE).get_hsl())\n",
        "            hsl[0] = interpolate(0.5, 0.6, value)\n",
        "            bar.set_fill(Color(hsl=hsl), 1)\n",
        "            bar.set_stroke(BLUE, 1)\n",
        "            prob.next_to(bar, LEFT)\n",
        "            probs.add(prob)\n",
        "            bars.add(bar)\n",
        "\n",
        "        probs.fix_in_frame()\n",
        "        bars.fix_in_frame()\n",
        "        brace = Brace(VGroup(probs, dots), LEFT).fix_in_frame()\n",
        "        arrow = Vector(RIGHT, stroke_width=8).fix_in_frame()\n",
        "        arrow.set_color(YELLOW)\n",
        "        arrow.next_to(brace, LEFT)\n",
        "\n",
        "        # Show creation\n",
        "        self.play(\n",
        "            LaggedStartMap(FadeIn, words, shift=0.1 * DOWN),\n",
        "            LaggedStartMap(FadeIn, bars),\n",
        "            LaggedStartMap(FadeIn, probs, shift=0.2 * LEFT),\n",
        "            GrowFromCenter(brace),\n",
        "            GrowArrow(arrow),\n",
        "        )\n",
        "        self.wait()\n",
        "\n",
        "        self.prob_group = VGroup(arrow, brace, words, bars, probs)\n",
        "        self.phrase = VGroup(phrase, q_group)\n",
        "\n",
        "    def show_unembedding_matrix(self, vector_index=-1):\n",
        "        # Clear frame\n",
        "        frame = self.frame\n",
        "        prob_group = self.prob_group\n",
        "        prob_group.save_state()\n",
        "        prob_group.generate_target()\n",
        "        prob_group.target.scale(0.5, about_edge=DR)\n",
        "        prob_group.target.to_corner(DR)\n",
        "        prob_group.target[0].set_opacity(0)\n",
        "\n",
        "        self.play(\n",
        "            FadeOut(self.phrase, UP),\n",
        "            MoveToTarget(prob_group),\n",
        "            frame.animate.reorient(0, 1, 0, (4.98, 3.34, 30.08), 12.00),\n",
        "            run_time=2,\n",
        "        )\n",
        "\n",
        "        # Show the weight matrix\n",
        "        layer = self.layers[-1]\n",
        "        vector = layer.embeddings[vector_index].copy()\n",
        "        matrix = WeightMatrix(\n",
        "            shape=(15, vector.shape[0]),\n",
        "            ellipses_row=8,\n",
        "        )\n",
        "        matrix.set_height(6)\n",
        "        matrix.next_to(vector, UP, aligned_edge=RIGHT, buff=1.0)\n",
        "        matrix.shift(LEFT)\n",
        "        last_vector_rect = rect = SurroundingRectangle(vector, buff=0.1)\n",
        "        rect.set_stroke(YELLOW, 3)\n",
        "        vector.generate_target()\n",
        "        vector.target.next_to(matrix, RIGHT)\n",
        "        last_vect_arrow = Arrow(\n",
        "            rect.get_top(), vector.target.get_bottom(),\n",
        "        )\n",
        "        last_vect_arrow.set_color(YELLOW)\n",
        "\n",
        "        self.play(\n",
        "            FadeIn(matrix, scale=0.8, shift=DR),\n",
        "            *map(FadeOut, [self.token_blocks, self.token_arrows, self.final_word_question]),\n",
        "        )\n",
        "        self.play(ShowCreation(rect))\n",
        "        self.play(MoveToTarget(vector), ShowCreation(last_vect_arrow))\n",
        "\n",
        "        # Show matrix vector product\n",
        "        eq, rhs = show_matrix_vector_product(self, matrix, vector)\n",
        "\n",
        "        # Count values\n",
        "        brace = Brace(rhs, RIGHT)\n",
        "        brace_label = brace.get_tex(R\"\\sim 50k \\text{ values}\", font_size=60, buff=0.25)\n",
        "\n",
        "        self.play(\n",
        "            GrowFromCenter(brace),\n",
        "            FadeIn(brace_label, lag_ratio=0.1),\n",
        "        )\n",
        "        brace_group = VGroup(brace, brace_label)\n",
        "\n",
        "        # Show words\n",
        "        word_strs = [\n",
        "            \"aah\",\n",
        "            \"aardvark\",\n",
        "            \"aardwolf\",\n",
        "            \"aargh\",\n",
        "            \"ab\",\n",
        "            \"aback\",\n",
        "            \"abacterial\",\n",
        "            \"abacus\",\n",
        "            \"...\",\n",
        "            \"zygote\",\n",
        "            \"zygotic\",\n",
        "            \"zyme\",\n",
        "            \"zymogen\",\n",
        "            \"zymosis\",\n",
        "            \"zzz\",\n",
        "        ]\n",
        "        words = VGroup(*map(Text, word_strs))\n",
        "        words[word_strs.index(\"...\")].rotate(PI / 2)\n",
        "        for word, entry in zip(words, rhs):\n",
        "            word.set_max_height(entry.get_height())\n",
        "            word.next_to(rhs, RIGHT, buff=0.25)\n",
        "            word.match_y(entry)\n",
        "\n",
        "        self.play(\n",
        "            LaggedStartMap(FadeIn, words, shift=0.5 * RIGHT),\n",
        "            brace_group.animate.next_to(words, RIGHT),\n",
        "        )\n",
        "        self.wait()\n",
        "\n",
        "        # Mention softmax\n",
        "        big_rect = SurroundingRectangle(VGroup(rhs, words), buff=0.25)\n",
        "        big_rect.set_fill(TEAL, 0.1)\n",
        "        big_rect.set_stroke(TEAL, 3)\n",
        "        softmax_arrow = Vector(2.2 * RIGHT, stroke_width=8)\n",
        "        softmax_arrow.next_to(big_rect, RIGHT, buff=0.1)\n",
        "        softmax_label = Text(\"softmax\", font_size=48)\n",
        "        softmax_label.next_to(softmax_arrow, UP, buff=0.35)\n",
        "\n",
        "        prob_group.generate_target()\n",
        "        prob_group.target[0].scale(0).move_to(prob_group)\n",
        "        prob_group.target.set_height(4)\n",
        "        prob_group.target.to_edge(UP, buff=0.25).to_edge(RIGHT, buff=0.1)\n",
        "\n",
        "        self.play(\n",
        "            LaggedStart(\n",
        "                FadeOut(brace_group),\n",
        "                DrawBorderThenFill(big_rect),\n",
        "                ShowCreation(softmax_arrow),\n",
        "                FadeIn(softmax_label, lag_ratio=0.1),\n",
        "            ),\n",
        "            MoveToTarget(prob_group, time_span=(1, 2))\n",
        "        )\n",
        "        prob_group.unfix_from_frame()\n",
        "        prob_group.match_height(rhs)\n",
        "        prob_group.next_to(softmax_arrow, RIGHT, buff=0.25)\n",
        "        self.wait()\n",
        "\n",
        "        # Ask about other vectors\n",
        "        rects = VGroup(*(\n",
        "            SurroundingRectangle(emb)\n",
        "            for emb in layer.embeddings[:-1]\n",
        "        ))\n",
        "        rects.set_stroke(PINK, 3)\n",
        "        rects.set_fill(PINK, 0.25)\n",
        "        question = Text(\"What about these?\", font_size=90)\n",
        "        question.next_to(layer, DOWN, buff=2.0)\n",
        "        question_arrows = VGroup()\n",
        "        for rect in rects:\n",
        "            question_arrows.add(Arrow(\n",
        "                question.get_top(), rect.get_bottom(),\n",
        "                stroke_color=rect.get_color()\n",
        "            ))\n",
        "\n",
        "        self.play(\n",
        "            frame.animate.reorient(-1, 0, 0, (1.69, 1.57, 29.79), 15.88),\n",
        "            Write(question),\n",
        "            run_time=2,\n",
        "        )\n",
        "\n",
        "        last_rect = VGroup()\n",
        "        for rect, arrow in zip(rects, question_arrows):\n",
        "            self.play(\n",
        "                FadeOut(last_rect),\n",
        "                FadeIn(rect),\n",
        "                FadeIn(arrow),\n",
        "            )\n",
        "            last_rect = rect\n",
        "        self.play(FadeOut(last_rect))\n",
        "        self.wait()\n",
        "\n",
        "        # Move back\n",
        "        self.play(\n",
        "            FadeOut(question_arrows, lag_ratio=0.1),\n",
        "            FadeOut(question, lag_ratio=0.1),\n",
        "            frame.animate.reorient(0, 1, 0, (4.27, 3.46, 29.83), 12.86),\n",
        "            run_time=2,\n",
        "        )\n",
        "        # self.play(\n",
        "        #     LaggedStartMap(FadeOut, VGroup(\n",
        "        #         *question_arrows, question,\n",
        "        #         matrix, vector, eq, rhs,\n",
        "        #         big_rect, softmax_arrow, prob_group, words, softmax_label,\n",
        "        #         last_vector_rect, last_vect_arrow,\n",
        "        #     )),\n",
        "        #     FadeOut(question_arrows, lag_ratio=0.1),\n",
        "        #     FadeOut(question, lag_ratio=0.1),\n",
        "        #     frame.animate.reorient(-2, 0, 0, (2.72, 1.82, 29.44), 10.31),\n",
        "        #     run_time=2,\n",
        "        # )\n",
        "        self.wait()\n",
        "\n",
        "        # Name the unembedding matrix\n",
        "        matrix_rect = SurroundingRectangle(matrix, buff=0.1)\n",
        "        matrix_rect.set_stroke(BLUE, 3)\n",
        "        name = Text(\"Unembedding\\nmatrix\", font_size=60)\n",
        "        label = Tex(\"W_U\", font_size=90)\n",
        "        name.next_to(matrix_rect, LEFT)\n",
        "        label.next_to(name, DOWN)\n",
        "\n",
        "        self.play(\n",
        "            Write(matrix_rect, stroke_width=5, stroke_color=BLUE),\n",
        "            Write(name, run_time=2),\n",
        "            frame.animate.reorient(0, 1, 0, (4.24, 3.15, 29.81), 13.23),\n",
        "        )\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            FadeIn(label, DOWN),\n",
        "            name.animate.next_to(label, UP, buff=1)\n",
        "        )\n",
        "        self.wait()\n",
        "\n",
        "        # Data flying\n",
        "        data_modifying_matrix(self, matrix)\n",
        "        self.wait()\n",
        "\n",
        "        # Count parameters\n",
        "        label.set_backstroke(BLACK, 6)\n",
        "        entries = VGroup(*matrix.elements, *matrix.ellipses)\n",
        "        row_rects = VGroup(*map(SurroundingRectangle, matrix.get_rows()))\n",
        "        col_rects = VGroup(*map(SurroundingRectangle, matrix.get_columns()))\n",
        "        VGroup(row_rects, col_rects).set_stroke(GREY, 1).set_fill(GREY_B, 0.5)\n",
        "\n",
        "        left_brace = Brace(matrix, LEFT)\n",
        "        top_brace = Brace(matrix, UP)\n",
        "        vocab_count = Integer(50257, font_size=90)\n",
        "        vocab_count.next_to(left_brace, LEFT)\n",
        "        dim_count = Integer(12288, font_size=90)\n",
        "        dim_count.next_to(top_brace, UP)\n",
        "\n",
        "        top_equation = VGroup(\n",
        "            Text(\"Total parameters = \"),\n",
        "            Integer(vocab_count.get_value()),\n",
        "            Tex(R\"\\times\"),\n",
        "            Integer(dim_count.get_value()),\n",
        "            Tex(\"=\"),\n",
        "            Integer(vocab_count.get_value() * dim_count.get_value()).set_color(YELLOW),\n",
        "        )\n",
        "        top_equation.arrange(RIGHT)\n",
        "        top_equation.scale(2)\n",
        "        top_equation.next_to(dim_count, UP, buff=1)\n",
        "        top_equation.align_to(vocab_count, LEFT)\n",
        "\n",
        "        self.play(\n",
        "            label.animate.move_to(matrix),\n",
        "            FadeOut(name, lag_ratio=0.1),\n",
        "            entries.animate.set_fill(opacity=0.5, border_width=0),\n",
        "        )\n",
        "        self.add(row_rects, label)\n",
        "        self.play(\n",
        "            GrowFromCenter(left_brace, time_span=(0, 1)),\n",
        "            CountInFrom(vocab_count),\n",
        "            LaggedStartMap(VFadeInThenOut, row_rects, lag_ratio=0.2),\n",
        "            run_time=2.5,\n",
        "        )\n",
        "        self.add(col_rects, label)\n",
        "        self.play(\n",
        "            GrowFromCenter(top_brace, time_span=(0, 1)),\n",
        "            CountInFrom(dim_count),\n",
        "            LaggedStartMap(VFadeInThenOut, col_rects, lag_ratio=0.2),\n",
        "            frame.animate.reorient(0, 0, 0, (5.66, 4.08, 29.89), 14.32),\n",
        "            run_time=2.5,\n",
        "        )\n",
        "        self.wait()\n",
        "        self.play(LaggedStart(\n",
        "            Write(top_equation[0:6:2]),\n",
        "            TransformFromCopy(vocab_count, top_equation[1]),\n",
        "            TransformFromCopy(dim_count, top_equation[3]),\n",
        "            frame.animate.reorient(0, -1, 0, (4.15, 5.07, 29.75), 17.21),\n",
        "            run_time=3\n",
        "        ))\n",
        "        self.play(\n",
        "            FadeTransform(top_equation[1:4].copy(), top_equation[-1])\n",
        "        )\n",
        "        self.wait()\n",
        "\n",
        "\n",
        "class FlowForMLPIntroReview(SimplifiedFlow):\n",
        "    example_text = \"That which does not kill you only makes you stronger\"\n",
        "    x_range = np.linspace(-2, -4, 3)\n",
        "    frame_height_growth_rate = 0.3\n",
        "    possible_next_tokens = [\n",
        "        (\"stronger\", 0.906),\n",
        "        (\"stranger\", 0.028),\n",
        "        (\"more\", 0.006),\n",
        "        (\"weaker\", 0.003),\n",
        "        (\"...\", 0.003),\n",
        "        (\"Strong\", 0.002),\n",
        "        (\"wish\", 0.002),\n",
        "        (\"STR\", 0.002),\n",
        "    ]\n",
        "\n",
        "    def construct(self):\n",
        "        # Initial flow\n",
        "        self.camera.light_source.set_z(20)\n",
        "        self.show_initial_text_embedding(word_scale_factor=0.6)\n",
        "        self.play(self.frame.animate.scale(1.25))\n",
        "        self.show_simple_flow(self.x_range)\n",
        "\n",
        "        # Show how it ends\n",
        "        self.remove_mlps()\n",
        "        self.mention_repetitions()\n",
        "        self.frame.clear_updaters()\n",
        "        self.focus_on_last_layer()\n",
        "        self.play(self.frame.animate.scale(1.15).shift(RIGHT))\n",
        "        self.show_unembedding()\n",
        "\n",
        "\n",
        "class FlowForCHM(SimplifiedFlow):\n",
        "    example_text = \"Down by the river bank ... until they jumped into the pond\"\n",
        "    use_words = True\n",
        "    x_range = np.linspace(-2, -4, 3)\n",
        "    frame_height_growth_rate = 0.3\n",
        "\n",
        "    def construct(self):\n",
        "        # Initial flow\n",
        "        self.camera.light_source.set_z(20)\n",
        "        self.show_initial_text_embedding(word_scale_factor=0.6)\n",
        "        self.play(self.frame.animate.scale(1.25))\n",
        "        self.show_simple_flow(self.x_range)\n",
        "\n",
        "        # Show how it ends\n",
        "        self.remove_mlps()\n",
        "        self.mention_repetitions()\n",
        "        self.frame.clear_updaters()\n",
        "        self.focus_on_last_layer()\n",
        "        self.play(self.frame.animate.scale(1.15).shift(RIGHT))\n",
        "        self.show_unembedding()\n",
        "\n",
        "    def progress_through_mlp_block(self, *args, **kwargs):\n",
        "        kwargs.update(\n",
        "            label_text=\"Feed Forward\",\n",
        "            title_font_size=92,\n",
        "        )\n",
        "        super().progress_through_mlp_block(*args, **kwargs)\n",
        "\n",
        "\n",
        "class FlowForCHM2(FlowForCHM):\n",
        "    example_text = \"The Computer History Museum is located in Mountain\"\n",
        "    possible_next_tokens = [\n",
        "        (\"Mountain\", 0.706),\n",
        "        (\"the\", 0.128),\n",
        "        (\"San\", 0.078),\n",
        "        (\"Seattle\", 0.006),\n",
        "        (\"New\", 0.003),\n",
        "        (\"Palo\", 0.002),\n",
        "        (\"Google\", 0.002),\n",
        "        (\"southern\", 0.002),\n",
        "    ]\n",
        "\n",
        "    def show_initial_text_embedding(self, word_scale_factor=0.6, bump_first=False):\n",
        "        super().show_initial_text_embedding(word_scale_factor=0.5)\n",
        "\n",
        "\n",
        "class TextToNumerical(SimplifiedFlow):\n",
        "    example_text = \"Text must be encoded as numbers blah\"\n",
        "    use_words = True\n",
        "\n",
        "    def construct(self):\n",
        "        # Test\n",
        "        self.show_initial_text_embedding(word_scale_factor=0.75)\n",
        "\n",
        "\n",
        "class FlowForCHMNoText(FlowForCHM2):\n",
        "    def get_block(self, *args, **kwargs):\n",
        "        kwargs.update(title=\"\")\n",
        "        return super().get_block(*args, **kwargs)\n",
        "\n",
        "\n",
        "class TextPassageIntro(InteractiveScene):\n",
        "    example_text = MentionContextSizeAndUnembedding.example_text\n",
        "\n",
        "    def construct(self):\n",
        "        # Read in passage\n",
        "        passage_str = Path(DATA_DIR, \"harry_potter_3.txt\").read_text()\n",
        "        passage_str = passage_str.replace(\"\\n\", \"\\n\\\\\\\\\")\n",
        "        passage = TexText(passage_str, alignment=\"\", additional_preamble=R\"\\tiny\")\n",
        "        passage.set_height(FRAME_HEIGHT - 1)\n",
        "        passage[-len(\"Snape\"):].set_opacity(0)\n",
        "\n",
        "        # Initial surroundings\n",
        "        frame = self.frame\n",
        "        lh, rh = (1176, 1540)\n",
        "        section = passage[lh:rh].copy()\n",
        "        section.save_state()\n",
        "        section.set_width(FRAME_WIDTH - 1)\n",
        "        section.center()\n",
        "\n",
        "        word_lh, word_rh = (150, 155)\n",
        "        word = section[word_lh:word_rh].copy()\n",
        "        word.save_state()\n",
        "        word.set_height(0.75).center()\n",
        "\n",
        "        self.play(Write(word))\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            Restore(word, time_span=(0, 0.5), remover=True),\n",
        "            ShowIncreasingSubsets(section),\n",
        "            run_time=1\n",
        "        )\n",
        "        self.play(ContextAnimation(word, section))\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            Restore(section, remover=True),\n",
        "            ShowIncreasingSubsets(VGroup(*passage[:lh], *passage[rh:]))\n",
        "        )\n",
        "        self.add(passage)\n",
        "        self.play(ContextAnimation(\n",
        "            passage[lh:rh][word_lh:word_rh],\n",
        "            VGroup(\n",
        "                *passage[0:11],\n",
        "                *passage[211:217],\n",
        "                # *passage[2366:2374],\n",
        "            ),\n",
        "            lag_ratio=0.01\n",
        "        ))\n",
        "        self.wait()\n",
        "\n",
        "        # Compress\n",
        "        start, end = self.example_text.split(\" ... \")\n",
        "        short_text = Text(self.example_text)\n",
        "        short_text[\"Snape\"].set_opacity(0)\n",
        "        short_text.set_max_width(FRAME_WIDTH - 1)\n",
        "        dots = short_text[\"...\"][0]\n",
        "\n",
        "        lh, rh = (31, 2474)\n",
        "        self.play(\n",
        "            FadeTransformPieces(\n",
        "                passage[:lh],\n",
        "                short_text[start][0],\n",
        "            ),\n",
        "            ReplacementTransform(passage[lh:rh], dots),\n",
        "            FadeTransformPieces(\n",
        "                passage[rh:],\n",
        "                short_text[end][0],\n",
        "            ),\n",
        "            run_time=3\n",
        "        )\n",
        "        self.add(short_text)\n",
        "        self.wait()\n",
        "\n",
        "\n",
        "class ThumbnailBase(HighLevelNetworkFlow):\n",
        "    block_to_title_direction = LEFT\n",
        "    def construct(self):\n",
        "        # Add blocks\n",
        "        self.show_initial_text_embedding(word_scale_factor=0.6)\n",
        "        for x in range(4):\n",
        "            self.progress_through_attention_block(\n",
        "                depth=1.5,\n",
        "                label_text=\"Att\"\n",
        "            )\n",
        "            self.progress_through_mlp_block(\n",
        "                depth=2.0,\n",
        "                label_text=\"MLP\"\n",
        "            )\n",
        "        self.frame.reorient(-45, -10, 0, (-2.9, 0.95, 24.44), 14.34)\n",
        "\n",
        "        # Fade title\n",
        "        for n, block in enumerate(self.blocks):\n",
        "            block.title.set_opacity(0)\n",
        "            block.body.set_opacity(0.5)\n",
        "        self.remove(*self.layers[:-1])\n",
        "\n",
        "        self.mention_repetitions()\n",
        "        self.rep_label[0].apply_depth_test()\n",
        "        self.rep_label[1:].set_opacity(0)\n",
        "        self.add(self.blocks)\n",
        "\n",
        "    example_text = \"The initials GPT stand for Generative Pre-trained Transformer\"\n",
        "\n",
        "\n",
        "class MoleExample1(HighLevelNetworkFlow):\n",
        "    block_to_title_direction = LEFT\n",
        "    highlighted_group_index = 1\n",
        "\n",
        "    def construct(self):\n",
        "        # Show three phrases\n",
        "        phrase_strs = [\n",
        "            \"American shrew mole\",\n",
        "            \"One mole of carbon dioxide\",\n",
        "            \"Take a biopsy of the mole\",\n",
        "        ]\n",
        "        phrases = VGroup(map(Text, phrase_strs))\n",
        "        phrases.arrange(DOWN, buff=2.0)\n",
        "        phrases.move_to(0.25 * DOWN)\n",
        "\n",
        "        self.play(Write(phrases[0]), run_time=1)\n",
        "        self.wait()\n",
        "        for i in [1, 2]:\n",
        "            self.play(\n",
        "                Transform(phrases[i - 1][\"mole\"].copy(), phrases[i][\"mole\"].copy(), remover=True),\n",
        "                FadeIn(phrases[i], lag_ratio=0.1)\n",
        "            )\n",
        "            self.wait()\n",
        "\n",
        "        # Add mole images\n",
        "        images = Group(\n",
        "            ImageMobject(\"ShrewMole\").set_height(1),\n",
        "            Tex(R\"6.02 \\times 10^{23}\").set_color(TEAL),\n",
        "            ImageMobject(\"LipMole\").set_height(1),\n",
        "        )\n",
        "        braces = VGroup()\n",
        "        mole_words = VGroup()\n",
        "        for image, phrase in zip(images, phrases):\n",
        "            mole_word = phrase[\"mole\"][0]\n",
        "            brace = Brace(mole_word, UP, SMALL_BUFF)\n",
        "            image.next_to(brace, UP, SMALL_BUFF)\n",
        "            braces.add(brace)\n",
        "            mole_words.add(mole_word)\n",
        "\n",
        "        self.play(\n",
        "            LaggedStartMap(GrowFromCenter, braces, lag_ratio=0.5),\n",
        "            LaggedStartMap(FadeIn, images, shift=UP, lag_ratio=0.5),\n",
        "            mole_words.animate.set_color(YELLOW).set_anim_args(lag_ratio=0.1),\n",
        "        )\n",
        "        self.wait()\n",
        "\n",
        "        # Subdivide\n",
        "        word_groups = VGroup()\n",
        "        for phrase in phrases:\n",
        "            words = break_into_words(phrase.copy())\n",
        "            rects = get_piece_rectangles(\n",
        "                words, leading_spaces=False, h_buff=0.05\n",
        "            )\n",
        "            word_group = VGroup(VGroup(*pair) for pair in zip(rects, words))\n",
        "            word_groups.add(word_group)\n",
        "\n",
        "        self.play(\n",
        "            FadeIn(word_groups),\n",
        "            LaggedStartMap(FadeOut, braces, shift=0.25 * DOWN, lag_ratio=0.25),\n",
        "            LaggedStartMap(FadeOut, images, shift=0.25 * DOWN, lag_ratio=0.25),\n",
        "            run_time=1\n",
        "        )\n",
        "        self.remove(phrases)\n",
        "        self.wait()\n",
        "\n",
        "        # Divide into three regions\n",
        "        for group, sign in zip(word_groups, [-1, 0, 1]):\n",
        "            group.target = group.generate_target()\n",
        "            group.target.scale(0.75)\n",
        "            group.target.set_x(sign * FRAME_WIDTH / 3)\n",
        "            group.target.to_edge(UP)\n",
        "\n",
        "        v_lines = Line(UP, DOWN).replicate(2)\n",
        "        v_lines.set_height(FRAME_HEIGHT)\n",
        "        v_lines.arrange(RIGHT, buff=FRAME_WIDTH / 3)\n",
        "        v_lines.center()\n",
        "        v_lines.set_stroke(GREY_B, 1)\n",
        "\n",
        "        self.play(\n",
        "            LaggedStartMap(MoveToTarget, word_groups),\n",
        "            ShowCreation(v_lines, lag_ratio=0.5, time_span=(1, 2))\n",
        "        )\n",
        "\n",
        "        # Show vector embeddings\n",
        "        embs = VGroup()\n",
        "        arrows = VGroup()\n",
        "        seed_array = np.random.uniform(0, 10, 7)\n",
        "        for group in word_groups:\n",
        "            for word in group:\n",
        "                arrow = Vector(0.5 * DOWN)\n",
        "                arrow.next_to(word, DOWN, SMALL_BUFF)\n",
        "                size = sum(len(m.get_points()) for m in  word.family_members_with_points())\n",
        "                values = (seed_array * size % 10)\n",
        "                emb = NumericEmbedding(values=values)\n",
        "                emb.set_height(2)\n",
        "                emb.next_to(arrow, DOWN, SMALL_BUFF)\n",
        "\n",
        "                arrows.add(arrow)\n",
        "                embs.add(emb)\n",
        "        mole_indices = [2, 4, 13]\n",
        "        non_mole_indices = [n for n in range(len(embs)) if n not in mole_indices]\n",
        "\n",
        "        mole_vect_rects = VGroup(\n",
        "            SurroundingRectangle(embs[index])\n",
        "            for index in mole_indices\n",
        "        )\n",
        "        mole_vect_rects.set_stroke(YELLOW, 2)\n",
        "\n",
        "        self.play(\n",
        "            LaggedStartMap(GrowArrow, arrows),\n",
        "            LaggedStartMap(FadeIn, embs, shift=0.25 * DOWN),\n",
        "        )\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            LaggedStartMap(ShowCreation, mole_vect_rects),\n",
        "            VGroup(arrows[j] for j in non_mole_indices).animate.set_fill(opacity=0.5),\n",
        "            VGroup(embs[j] for j in non_mole_indices).animate.set_fill(opacity=0.5),\n",
        "        )\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            FadeOut(mole_vect_rects)\n",
        "        )\n",
        "\n",
        "        # Prepare to pass through an attention block\n",
        "        wg_lens = [len(wg) for wg in word_groups]\n",
        "        indices = [0, *np.cumsum(wg_lens)]\n",
        "        full_groups = VGroup(\n",
        "            VGroup(wg, arrows[i:j], embs[i:j])\n",
        "            for wg, i, j in zip(word_groups, indices, indices[1:])\n",
        "        )\n",
        "        highlighted_group = full_groups[self.highlighted_group_index]\n",
        "        fade_groups = [fg for n, fg in enumerate(full_groups) if n != self.highlighted_group_index]\n",
        "        highlighted_group.target = highlighted_group.generate_target()\n",
        "        highlighted_group.target.scale(1.5, about_edge=UP)\n",
        "        highlighted_group.target.space_out_submobjects(1.1)\n",
        "        highlighted_group.target.center()\n",
        "        highlighted_group.target[2].set_fill(opacity=1)\n",
        "\n",
        "        self.play(\n",
        "            FadeOut(v_lines, time_span=(0, 1)),\n",
        "            MoveToTarget(highlighted_group, lag_ratio=5e-4),\n",
        "            *(\n",
        "                FadeOut(\n",
        "                    fg,\n",
        "                    shift=fg.get_center() - highlighted_group.get_center() + 2 * DOWN,\n",
        "                    lag_ratio=1e-3\n",
        "                )\n",
        "                for fg in  fade_groups\n",
        "            ),\n",
        "            run_time=2\n",
        "        )\n",
        "        self.wait()\n",
        "\n",
        "        # Pass through attention\n",
        "        layer = VGroup(highlighted_group[2])\n",
        "        layer.embeddings = highlighted_group[2]\n",
        "        self.layers.set_submobjects([])\n",
        "        self.layers.add(layer)\n",
        "\n",
        "        self.progress_through_attention_block(target_frame_x=-2)\n",
        "        self.wait()\n"
    ]
}