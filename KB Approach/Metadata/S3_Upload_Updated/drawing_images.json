{
    "topic": "demonstrates the concept of nearest neighbor alignment, which is a technique used to align two objects",
    "code": [
        "import numpy as np\n",
        "import itertools as it\n",
        "import operator as op\n",
        "import sys\n",
        "import inspect\n",
        "from PIL import Image\n",
        "import cv2\n",
        "import random\n",
        "from scipy.spatial.distance import cdist\n",
        "from scipy import ndimage\n",
        "\n",
        "from manim_imports_ext import *\n",
        "\n",
        "\n",
        "DEFAULT_GAUSS_BLUR_CONFIG = {\n",
        "    \"ksize\"  : (5, 5), \n",
        "    \"sigmaX\" : 6, \n",
        "    \"sigmaY\" : 6,\n",
        "}\n",
        "\n",
        "DEFAULT_CANNY_CONFIG = {\n",
        "    \"threshold1\" : 50,\n",
        "    \"threshold2\" : 100,\n",
        "}\n",
        "\n",
        "DEFAULT_BLUR_RADIUS = 0.5\n",
        "DEFAULT_CONNECTED_COMPONENT_THRESHOLD = 25\n",
        "\n",
        "\n",
        "def reverse_colors(nparray):\n",
        "    return nparray[:,:,[2, 1, 0]]\n",
        "\n",
        "def show(nparray):\n",
        "    Image.fromarray(reverse_colors(nparray)).show()\n",
        "\n",
        "\n",
        "def thicken(nparray):\n",
        "    height, width = nparray.shape\n",
        "    nparray = nparray.reshape((height, width, 1))\n",
        "    return np.repeat(nparray, 3, 2)\n",
        "\n",
        "def sort_by_color(mob):\n",
        "    indices = np.argsort(np.apply_along_axis(\n",
        "        lambda p : -get_norm(p),\n",
        "        1,\n",
        "        mob.rgbas\n",
        "    ))\n",
        "    mob.rgbas = mob.rgbas[indices]    \n",
        "    mob.points = mob.get_points()[indices]\n",
        "\n",
        "\n",
        "\n",
        "def get_image_array(name):\n",
        "    image_files = os.listdir(IMAGE_DIR)\n",
        "    possibilities = [s for s in image_files if s.startswith(name)]\n",
        "    for possibility in possibilities:\n",
        "        try:\n",
        "            path = os.path.join(IMAGE_DIR, possibility)\n",
        "            image = Image.open(path)\n",
        "            image = image.convert('RGB')\n",
        "            return np.array(image)\n",
        "        except:\n",
        "            pass\n",
        "    raise Exception(\"Image for %s not found\"%name)\n",
        "\n",
        "def get_edges(image_array):\n",
        "    blurred = cv2.GaussianBlur(\n",
        "        image_array, \n",
        "        **DEFAULT_GAUSS_BLUR_CONFIG\n",
        "    )\n",
        "    edges = cv2.Canny(\n",
        "        blurred, \n",
        "        **DEFAULT_CANNY_CONFIG\n",
        "    )\n",
        "    return edges\n",
        "\n",
        "def nearest_neighbor_align(mobject1, mobject2):\n",
        "    distance_matrix = cdist(mobject1.points, mobject2.points)\n",
        "    closest_point_indices = np.apply_along_axis(\n",
        "        np.argmin, 0, distance_matrix\n",
        "    )\n",
        "    new_mob1 = Mobject()\n",
        "    new_mob2 = Mobject()\n",
        "    for n in range(mobject1.get_num_points()):\n",
        "        indices = (closest_point_indices == n)\n",
        "        new_mob1.add_points(\n",
        "            [mobject1.get_points()[n]]*sum(indices)\n",
        "        )\n",
        "        new_mob2.add_points(\n",
        "            mobject2.get_points()[indices],\n",
        "            rgbas = mobject2.rgbas[indices]\n",
        "        )\n",
        "    return new_mob1, new_mob2\n",
        "\n",
        "def get_connected_components(image_array, \n",
        "                             blur_radius = DEFAULT_BLUR_RADIUS, \n",
        "                             threshold = DEFAULT_CONNECTED_COMPONENT_THRESHOLD):\n",
        "    blurred_image = ndimage.gaussian_filter(image_array, blur_radius)\n",
        "    labels, component_count = ndimage.label(blurred_image > threshold)\n",
        "    return [\n",
        "        image_array * (labels == count)\n",
        "        for count in range(1, component_count+1)\n",
        "    ]\n",
        "\n",
        "def color_region(bw_region, colored_image):\n",
        "    return thicken(bw_region > 0) * colored_image\n",
        "\n",
        "\n",
        "class TracePicture(Scene):\n",
        "    args_list = [\n",
        "        (\"Newton\",),\n",
        "        (\"Mark_Levi\",),\n",
        "        (\"Steven_Strogatz\",),\n",
        "        (\"Pierre_de_Fermat\",),\n",
        "        (\"Galileo_Galilei\",),\n",
        "        (\"Jacob_Bernoulli\",),\n",
        "        (\"Johann_Bernoulli2\",),\n",
        "        (\"Old_Newton\",)\n",
        "    ]\n",
        "\n",
        "    @staticmethod\n",
        "    def args_to_string(name):\n",
        "        return name\n",
        "        \n",
        "    @staticmethod\n",
        "    def string_to_args(name):\n",
        "        return name\n",
        "\n",
        "    def construct(self, name):\n",
        "        run_time = 20\n",
        "        scale_factor = 0.8\n",
        "        image_array = get_image_array(name)\n",
        "        edge_mobject = self.get_edge_mobject(image_array)\n",
        "        full_picture = MobjectFromPixelArray(image_array)\n",
        "        for mob in edge_mobject, full_picture:\n",
        "            # mob.stroke_width = 4\n",
        "            mob.scale(scale_factor)\n",
        "            mob.show()\n",
        "\n",
        "        self.play(\n",
        "            DelayByOrder(FadeIn(\n",
        "                full_picture,\n",
        "                run_time = run_time,\n",
        "                rate_func = squish_rate_func(smooth, 0.7, 1)\n",
        "            )),\n",
        "            ShowCreation(\n",
        "                edge_mobject,\n",
        "                run_time = run_time,\n",
        "                rate_func=linear\n",
        "            )\n",
        "        )\n",
        "        self.remove(edge_mobject)\n",
        "        self.wait()\n",
        "\n",
        "\n",
        "    def get_edge_mobject(self, image_array):\n",
        "        edged_image = get_edges(image_array)\n",
        "        individual_edges = get_connected_components(edged_image)\n",
        "        colored_edges = [\n",
        "            color_region(edge, image_array)\n",
        "            for edge in individual_edges\n",
        "        ]\n",
        "        colored_edge_mobject_list = [\n",
        "            MobjectFromPixelArray(colored_edge)\n",
        "            for colored_edge in colored_edges\n",
        "        ]\n",
        "        random.shuffle(colored_edge_mobject_list)\n",
        "        edge_mobject = Mobject(*colored_edge_mobject_list)\n",
        "        edge_mobject.ingest_submobjects()\n",
        "        return edge_mobject\n",
        "\n",
        "\n",
        "\n",
        "class JohannThinksHeIsBetter(Scene):\n",
        "    def construct(self):\n",
        "        names = [\n",
        "            \"Johann_Bernoulli2\",\n",
        "            \"Jacob_Bernoulli\",\n",
        "            \"Gottfried_Wilhelm_von_Leibniz\",\n",
        "            \"Newton\"\n",
        "        ]\n",
        "        guys = [\n",
        "            ImageMobject(name, invert = False)\n",
        "            for name in names\n",
        "        ]\n",
        "        johann = guys[0]\n",
        "        johann.scale(0.8)\n",
        "        pensive_johann = johann.copy()\n",
        "        pensive_johann.scale(0.25)\n",
        "        pensive_johann.to_corner(DOWN+LEFT)\n",
        "        comparitive_johann = johann.copy()\n",
        "        template = Square(side_length = 2)\n",
        "        comparitive_johann.replace(template)\n",
        "        comparitive_johann.shift(UP+LEFT)\n",
        "        greater_than = OldTex(\">\")\n",
        "        greater_than.next_to(comparitive_johann)\n",
        "        for guy, name in zip(guys, names)[1:]:\n",
        "            guy.replace(template)\n",
        "            guy.next_to(greater_than)\n",
        "            name_mob = OldTexText(name.replace(\"_\", \" \"))\n",
        "            name_mob.scale(0.5)\n",
        "            name_mob.next_to(guy, DOWN)\n",
        "            guy.name_mob = name_mob\n",
        "            guy.sort_points(lambda p : np.dot(p, DOWN+RIGHT))\n",
        "        bubble = ThoughtBubble(initial_width = 12)\n",
        "        bubble.stretch_to_fit_height(6)\n",
        "        bubble.ingest_submobjects()\n",
        "        bubble.pin_to(pensive_johann)\n",
        "        bubble.shift(DOWN)\n",
        "        point = Point(johann.get_corner(UP+RIGHT))\n",
        "        upper_point = Point(comparitive_johann.get_corner(UP+RIGHT))\n",
        "        lightbulb = ImageMobject(\"Lightbulb\", invert = False)\n",
        "        lightbulb.scale(0.1)\n",
        "        lightbulb.sort_points(get_norm)\n",
        "        lightbulb.next_to(upper_point, RIGHT)\n",
        "\n",
        "        self.add(johann)\n",
        "        self.wait()\n",
        "        self.play(\n",
        "            Transform(johann, pensive_johann),\n",
        "            Transform(point, bubble),\n",
        "            run_time = 2\n",
        "        )\n",
        "        self.remove(point)\n",
        "        self.add(bubble)\n",
        "        weakling = guys[1]        \n",
        "        self.play(\n",
        "            FadeIn(comparitive_johann),\n",
        "            ShowCreation(greater_than),\n",
        "            FadeIn(weakling)\n",
        "        )\n",
        "        self.wait(2)\n",
        "        for guy in guys[2:]:\n",
        "            self.play(DelayByOrder(Transform(\n",
        "                weakling, upper_point\n",
        "            )))\n",
        "            self.play(\n",
        "                FadeIn(guy),\n",
        "                ShimmerIn(guy.name_mob)\n",
        "            )\n",
        "            self.wait(3)\n",
        "            self.remove(guy.name_mob)\n",
        "            weakling = guy\n",
        "        self.play(FadeOut(weakling), FadeOut(greater_than))\n",
        "        self.play(ShowCreation(lightbulb))\n",
        "        self.wait()\n",
        "        self.play(FadeOut(comparitive_johann), FadeOut(lightbulb))\n",
        "        self.play(ApplyMethod(\n",
        "            Mobject(johann, bubble).scale, 10,\n",
        "            run_time = 3\n",
        "        ))\n",
        "\n",
        "\n",
        "class NewtonVsJohann(Scene):\n",
        "    def construct(self):\n",
        "        newton, johann = [\n",
        "            ImageMobject(name, invert = False).scale(0.5)\n",
        "            for name in (\"Newton\", \"Johann_Bernoulli2\")\n",
        "        ]\n",
        "        greater_than = OldTex(\">\")\n",
        "        newton.next_to(greater_than, RIGHT)\n",
        "        johann.next_to(greater_than, LEFT)\n",
        "        self.add(johann, greater_than, newton)\n",
        "        for i in range(2):\n",
        "            kwargs = {\n",
        "                \"path_func\" : counterclockwise_path(),\n",
        "                \"run_time\"  : 2 \n",
        "            }\n",
        "            self.play(\n",
        "                ApplyMethod(newton.replace, johann, **kwargs),\n",
        "                ApplyMethod(johann.replace, newton, **kwargs),\n",
        "            )\n",
        "            self.wait()\n",
        "\n",
        "\n",
        "class JohannThinksOfFermat(Scene):\n",
        "    def construct(self):\n",
        "        johann, fermat = [\n",
        "            ImageMobject(name, invert = False)\n",
        "            for name in (\"Johann_Bernoulli2\", \"Pierre_de_Fermat\")\n",
        "        ]\n",
        "        johann.scale(0.2)\n",
        "        johann.to_corner(DOWN+LEFT)\n",
        "        bubble = ThoughtBubble(initial_width = 12)\n",
        "        bubble.stretch_to_fit_height(6)\n",
        "        bubble.pin_to(johann)\n",
        "        bubble.shift(DOWN)\n",
        "        bubble.add_content(fermat)\n",
        "        fermat.scale(0.4)\n",
        "\n",
        "\n",
        "        self.add(johann, bubble)\n",
        "        self.wait()\n",
        "        self.play(FadeIn(fermat))\n",
        "        self.wait()\n",
        "\n",
        "\n",
        "class MathematiciansOfEurope(Scene):\n",
        "    def construct(self):\n",
        "        europe = ImageMobject(\"Europe\", use_cache = False)\n",
        "        self.add(europe)\n",
        "        self.freeze_background()\n",
        "\n",
        "        mathematicians = [\n",
        "            (\"Newton\", [-1.75, -0.75, 0]),\n",
        "            (\"Jacob_Bernoulli\",[-0.75, -1.75, 0]),\n",
        "            (\"Ehrenfried_von_Tschirnhaus\",[0.5, -0.5, 0]),\n",
        "            (\"Gottfried_Wilhelm_von_Leibniz\",[0.2, -1.75, 0]),\n",
        "            (\"Guillaume_de_L'Hopital\", [-1.75, -1.25, 0]),\n",
        "        ]\n",
        "\n",
        "        for name, point in mathematicians:\n",
        "            man = ImageMobject(name, invert = False)\n",
        "            if name == \"Newton\":\n",
        "                name = \"Isaac_Newton\"\n",
        "            name_mob = OldTexText(name.replace(\"_\", \" \"))\n",
        "            name_mob.to_corner(UP+LEFT, buff=0.75)\n",
        "            self.add(name_mob)\n",
        "            man.set_height(4)\n",
        "            mobject = Point(man.get_corner(UP+LEFT))\n",
        "            self.play(Transform(mobject, man))\n",
        "            man.scale(0.2)\n",
        "            man.shift(point)\n",
        "            self.play(Transform(mobject, man))\n",
        "            self.remove(name_mob)\n",
        "\n",
        "class OldNewtonIsDispleased(Scene):\n",
        "    def construct(self):\n",
        "        old_newton = ImageMobject(\"Old_Newton\", invert = False)\n",
        "        old_newton.scale(0.8)\n",
        "        self.add(old_newton)\n",
        "        self.freeze_background()\n",
        "\n",
        "        words = OldTexText(\"Note the displeasure\")\n",
        "        words.to_corner(UP+RIGHT)\n",
        "        face_point = 1.8*UP+0.5*LEFT\n",
        "        arrow = Arrow(words.get_bottom(), face_point)\n",
        "\n",
        "\n",
        "        self.play(ShimmerIn(words))\n",
        "        self.play(ShowCreation(arrow))\n",
        "        self.wait()\n",
        "\n",
        "\n",
        "class NewtonConsideredEveryoneBeneathHim(Scene):\n",
        "    def construct(self):\n",
        "        mathematicians = [\n",
        "            ImageMobject(name, invert = False)\n",
        "            for name in [\n",
        "                \"Old_Newton\",\n",
        "                \"Johann_Bernoulli2\",\n",
        "                \"Jacob_Bernoulli\",\n",
        "                \"Ehrenfried_von_Tschirnhaus\",\n",
        "                \"Gottfried_Wilhelm_von_Leibniz\",\n",
        "                \"Guillaume_de_L'Hopital\",\n",
        "            ]\n",
        "        ]\n",
        "        newton = mathematicians.pop(0)\n",
        "        newton.scale(0.8)\n",
        "        new_newton = newton.copy()\n",
        "        new_newton.set_height(3)\n",
        "        new_newton.to_edge(UP)\n",
        "        for man in mathematicians:\n",
        "            man.set_width(1.7)\n",
        "        johann = mathematicians.pop(0)\n",
        "        johann.next_to(new_newton, DOWN)\n",
        "        last_left, last_right = johann, johann\n",
        "        for man, count in zip(mathematicians, it.count()):\n",
        "            if count%2 == 0:\n",
        "                man.next_to(last_left, LEFT)\n",
        "                last_left = man\n",
        "            else:\n",
        "                man.next_to(last_right, RIGHT)\n",
        "                last_right = man\n",
        "\n",
        "        self.play(\n",
        "            Transform(newton, new_newton),\n",
        "            GrowFromCenter(johann)\n",
        "        )\n",
        "        self.wait()\n",
        "        self.play(FadeIn(Mobject(*mathematicians)))\n",
        "        self.wait()\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n"
    ]
}